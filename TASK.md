あなたはシニアWebエンジニア兼AIアーキテクトです。
このプロジェクトでは「人格が成長するAI Twitter運用アプリ」を実装します。

最重要要件：
- 人格は4層構造（コア / 長期 / 短期 / 外界フィードバック）
- 人格は数値最適化しない
- 成功・失敗・バズを評価軸にしない
- 人格はService Role経由でのみ更新される
- User権限で人格を書き換えてはいけない

技術スタック：
- Next.js App Router
- TypeScript
- Supabase（Auth / RLS / Postgres）
- Cron（Supabase Scheduled Functions or Vercel Cron）
- OpenAI API（JSON出力前提）
- twitter v2 API

制約：
- DB設計・RLS・API権限表はすでに一部定義している。
  ・DB設計  ./supabase/sql.txt
  ・RLS     ./supabase/sql.txt
  ・API権限 ./api.permission.matrix.txt
- AIはDBに直接アクセスしない
- 1 API = 1 人格責務


以下のルールを必ず守ってください。

1. API Route はすべて Next.js Route Handler で実装する
2. Supabase client は以下を使い分ける
   - User操作: createBrowserClient / createServerClient
   - 人格更新・cron: service_role key
3. 人格層をまたいで更新するAPIは禁止
4. OpenAI呼び出しは必ず JSON schema validation を行う
5. RLS前提で「通るコード」を書くこと
6. 仮実装・TODOコメントは禁止
7. 例外処理・ログ出力を必ず入れる
8. 各プロンプトの実行の際には必ずプロンプトの先頭に「prompts/common.txt」の内容を記載する。

このアプリは「人格を操作するツール」ではなく、
「人格が共に育つ環境」です。

あなたが書くコードは、
人格の変化を急がせてはいけません。


実行時AI（OpenAI）に渡すプロンプトは、
すでに別途定義されたものを使用します。
./prompts/ の配下にあります。

あなたは：
- プロンプト文言を大幅に変更しない
- 変数埋め込みを行う
- 出力JSONを厳密にパースする

以下にアプリの仕様を記述します。仕様に沿って実装を行なってください。
DB設計には一部のテーブルやカラムが欠けている可能性があります。現時点でユーザ管理のテーブルがありません。
sqlは適宜追加してください。

0.新規登録 or ログイン
    0-1.新規ユーザの場合は新規登録ページに遷移する
    0-2.新規登録ページでは、メールアドレスとパスワードを入力する    
    0-3.認証コード入力画面に遷移し、メールアドレスに送られた認証コードと一致した場合、ユーザテーブルにレコードを登録する。
    0-4.認証完了後、相棒の名前を入力する
    0-5.相棒の名前を入力後、トップページに遷移する
    0-6.ログインユーザの場合は、メールアドレスとパスワードを入力後、トップページに遷移する
    0-7.トップページでは、相棒の名前を表示する。
1.ユーザは相棒と共にこのアプリケーションを体験します。相棒とは、tweet文を生成するAIのことです。
2.ユーザはアプリケーション画面で「思考ログ」を入力することができる。
    2-1.「思考ログ」が入力されると、「prompts/thought-log.txt」のプロンプトを使用して、AIが人格形成のための要素を抽出する。
    2-2.抽出された要素をDBに保存する。
    2-2.思考ログの蓄積数を「長期人格」の生成用と「短期人格」の生成用に、それぞれユーザ管理テーブルで保持する。それぞれが規定の累積数に到達し生成が実行されると、累積数はリセットされる。
    2-3.思考ログの蓄積数が30に到達した場合「prompts/long-term-1.txt」「prompts/long-term-2.txt」のプロンプトを順番に実行する。
    2-4.思考ログの蓄積数が5に到達した場合「prompts/short-term.txt」のプロンプトを使用して「短期人格」を抽出する
    2-5.persona_short_termテーブルにデータがある場合、データをpersona_short_term_historyに移動させてから、抽出された要素をDBに保存する。
3.ユーザはアプリケーション画面でtweet文生成をリクエストすることができる。思考ログの累計数が5件以下の場合はリクエストをすることができない。リクエストボタンはUI上で非活性にし、残り何件必要であるかをユーザに示す。
    3-1.persona_coreテーブルからコア人格を取得する。
    3-3.persona_short_termテーブルから短期人格を取得する。 
    3-2.persona_long_termテーブルから長期人格を取得する。長期人格が存在しない場合は省略する。
    3-4.external_feedbackテーブルから最新の外部フィードバックを取得する。
    3-5.「prompts/tweets-generate.txt」のプロンプトを使用して、AIがtweet文を生成する。
    3-6.生成されたtweet文をtweets_generatedテーブルに保存する。
    3-7.生成されたtweet文をUIに表示する。UIの表示は3つのtweet文をカード形式で並べて表示する。編集ボタンから、ユーザが編集可能な状態とする。編集後はtweets_generatedテーブルを更新する。
    3-8.カードの投稿ボタンを押すと、twitterのAPIが実行され、投稿されたtweetはtweets_postedテーブルに保存される。tweet_metricsテーブルにもレコードが登録される。
    3-9.ユーザに投稿が完了したことを通知し、カードの表示はUIから削除する。
    3-10.tweetから24時間経過後、tweet_metricsテーブルから必要な情報を取得し「prompts/feedback.txt」のプロンプトを使用して、AIが「外部フィードバック」を生成する。生成された外部フィードバックはexternal_feedbackテーブルに保存する。

画面項目とUIデザインイメージ
・アプリケーションは対話型で、ユーザは相棒とチャットを交わす感覚で思考ログの入力や、投稿ができる。
・相棒のアイコンは動物のイラストアイコン5つから選択可能とし、ユーザが画像をアップロードして相棒のアイコンに設定することもできる。
・アプリケーション全体のテーマカラーは下記の5つからユーザ自身で選択可能。
    --soft（default）
    --dark
    --light
    --midnight
    --sunset
・対話形式のチャットでは、相棒は「思考ログを入力」「投稿する」の２つのボタンを表示していて、「思考ログを入力」を押すとユーザは相棒にチャット（思考ログ）を送ることができる。
・設定画面では、以下の項目を設定できる
    --相棒のアイコン
    --相棒の名前
    --テーマカラー
    --X連携/連携解除
・ログイン画面と設定画面では、目立たないUIでフッターを表示する。フッターにはコピーライトと「利用規約」「プライバシーポリシー」「お問い合わせ」のリンクを表示する。各ページも作成してください。お問い合わせの連絡先は「habab@hanablabs.info」とする。
・react bitsのコンポーネントを使用して、インタラクティブなUIを実装する。


    




